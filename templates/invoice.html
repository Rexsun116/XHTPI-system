<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>INVOICE - {{ pi.pi_no }}</title>
  <style>
    @page {
      size: A4;
      margin: 30px;
    }
    
    body {
      font-family: "Microsoft YaHei","Arial", sans-serif;
      margin: 0;
      padding: 15px;
      font-size: 14px;
      line-height: 1.2;
    }
    
    h1 {
      font-family: "Arial", sans-serif;
      font-weight: bold;
      text-align: center;
      font-size: 18px;
      margin: 8px 0;
    }
    
    .section { 
      margin-bottom: 12px; 
    }
    
    .bold { 
      font-weight: bold; 
    }
    
    .right { 
      text-align: right; 
    }
    
    .company-header {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .company-address {
      text-align: center;
      font-size: 11px;
      margin-bottom: 8px;
    }
    
    .invoice-info {
      margin-bottom: 10px;
    }
    
    .customer-info {
      margin-bottom: 10px;
    }
    
    .payment-shipping {
      margin-bottom: 10px;
    }
    
    .product-table {
      margin-bottom: 10px;
    }
    
    .bank-info {
      margin-bottom: 10px;
    }
    
    .footer-note {
      font-size: 11px;
      margin-bottom: 8px;
    }
    
    .footer-company {
      text-align: right;
      font-size: 14px;
    }
    
    .flex-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .flex-item {
      flex: 1;
    }
    
    .flex-item.right {
      text-align: right;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    
    th, td {
      border: 1px solid black;
      padding: 4px;
      text-align: center;
    }
    
    .no-border td {
      border: none;
      padding: 2px;
    }
    
    hr {
      width: 100%;
      margin: 5px auto;
    }
    
    pre {
      font-family: inherit;
      white-space: pre-wrap;
      margin: 0;
      font-size: 12px;
    }
  </style>
</head>
<body>

  <!-- 出口商信息 -->
  <div class="company-header">
    {{ pi.exporter.name.replace(';', '<br>')|safe }}
  </div>
  <hr>
  <div class="company-address">
    {{ pi.exporter.address }}
  </div>

  <!-- 标题 -->
  <h1>INVOICE</h1>

  <!-- 发票信息 -->
  <div class="invoice-info">
    <table class="no-border">
      <tr>
        <td style="text-align: right;"><strong>INVOICE NO:</strong> {{ pi.pi_no }}</td>
      </tr>
      <tr>
        <td style="text-align: right;"><strong>DATE:</strong> {{ pi.pi_date.strftime('%Y/%m/%d') }}</td>
      </tr>
    </table>
  </div>

  <!-- 客户信息 -->
  <div class="customer-info">
    <strong>TO:</strong>
    <strong>{{ pi.customer.name }}</strong><br>
    {{ pi.customer.address.replace(';', '<br>')|safe }}<br>
    {% if pi.customer.tax_code %}
    {{ pi.customer.tax_code.replace(';','<br>')|safe }}<br>
    {% endif %}
  </div>

  <!-- 付款及装运信息 -->
  <div class="payment-shipping">
    <strong>PAYMENT:</strong> {{ pi.payment_terms }}<br><br>
    <div class="flex-container">
      <div class="flex-item"><strong>LOADING PORT:</strong> {{ pi.loading_port }}</div>
      <div class="flex-item right"><strong>DESTINATION PORT:</strong> {{ pi.destination_port }}</div>
    </div>
  </div>

  <!-- 产品表格 -->
  <div class="product-table">
    <table>
      <thead>
        <tr>
          <th>Name of the Commodity</th>
          <th>Unit Price (USD)</th>
          <th>Quantity (MT)</th>
          <th>Amount (USD)</th>
        </tr>
      </thead>
      <tbody>
        {% set ns = namespace(total=0) %}
        {% for item in pi.products %}
        <tr>
          <td>
            {{ item.product.category }} {{ item.product.brand or "" }} {{ item.product.model }}
          </td>
          <td>{{ item.unit_price | round(0, 'floor') | int }}<br>{{ item.trade_term }} {{ pi.destination_port }}</td>
          <td>{{ item.quantity | round(0, 'floor') | int }}</td>
          <td>{{ item.total_price | round(0, 'floor') | int }}</td>
        </tr>
        {% set ns.total = ns.total + (item.total_price or 0) %}
        {% endfor %}
        <tr>
          <td colspan="3" class="right bold">TOTAL</td>
          <td class="bold">{{ ns.total | round(0, 'floor') | int }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 银行信息 -->
  <div class="bank-info">
    <strong>PAYMENT ROUTE:</strong><br>
    <pre>{{ pi.bank or "" }}</pre>
  </div>

  <!-- 页脚 -->
  <div class="footer-note">
    **NOTE <br>
    DOCUMENTS ISSUED BY ELECTRONIC PROCESS. NO SIGN OR STAMP REQUIRED.
  </div>

  <div class="footer-company">
    {{ pi.exporter.name.replace(';', '<br>')|safe }}
  </div>

</body>
</html>
