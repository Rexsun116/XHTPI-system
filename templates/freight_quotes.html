{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8">
      <h2><i class="fas fa-dollar-sign me-2"></i>货代报价管理</h2>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-plus me-2"></i>添加报价</h5>
        </div>
        <div class="card-body">
          <form method="post">
            <div class="mb-3">
              <label for="freight_forwarder_id" class="form-label">货代公司 *</label>
              <select class="form-select" id="freight_forwarder_id" name="freight_forwarder_id" required>
                <option value="">请选择货代</option>
                {% for ff in freight_forwarders %}
                <option value="{{ ff.id }}">{{ ff.code }} - {{ ff.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="shipping_company" class="form-label">船公司 *</label>
              <input type="text" class="form-control" id="shipping_company" name="shipping_company" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="departure_port" class="form-label">出发港 *</label>
                <input type="text" class="form-control" id="departure_port" name="departure_port" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="destination_port" class="form-label">目的港 *</label>
                <input type="text" class="form-control" id="destination_port" name="destination_port" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="route_type" class="form-label">航线类型 *</label>
              <select class="form-select" id="route_type" name="route_type" required>
                <option value="">请选择</option>
                <option value="直航">直航</option>
                <option value="转运">转运</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="price" class="form-label">价格 (USD/20GP) *</label>
              <input type="number" step="0.01" class="form-control" id="price" name="price" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="quote_date" class="form-label">报价日期 *</label>
                <input type="date" class="form-control" id="quote_date" name="quote_date" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="valid_until" class="form-label">有效期至 *</label>
                <input type="date" class="form-control" id="valid_until" name="valid_until" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="destination_14_days" class="form-label">目的港14天</label>
              <select class="form-select" id="destination_14_days" name="destination_14_days">
                <option value="">请选择</option>
                <option value="有">有</option>
                <option value="无">无</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="remarks" class="form-label">备注</label>
              <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save me-1"></i>保存报价
            </button>
          </form>
        </div>
      </div>
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-list me-2"></i>报价列表</h5>
        </div>
        <div class="card-body">
          <!-- 筛选栏 -->
          <div class="row mb-3">
            <div class="col-md-12">
              <form method="get" class="row g-3">
                <div class="col-md-2">
                  <label for="filter_freight_forwarder" class="form-label">货代</label>
                  <select class="form-select form-select-sm" id="filter_freight_forwarder" name="freight_forwarder">
                    <option value="">全部</option>
                    {% for ff in freight_forwarders %}
                    <option value="{{ ff.id }}" {% if request.args.get('freight_forwarder') and request.args.get('freight_forwarder')|int == ff.id %}selected{% endif %}>{{ ff.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="filter_shipping_company" class="form-label">船公司</label>
                  <input type="text" class="form-control form-control-sm" id="filter_shipping_company" name="shipping_company" 
                         value="{{ request.args.get('shipping_company', '') }}" placeholder="输入船公司">
                </div>
                <div class="col-md-2">
                  <label for="filter_departure_port" class="form-label">出发港</label>
                  <input type="text" class="form-control form-control-sm" id="filter_departure_port" name="departure_port" 
                         value="{{ request.args.get('departure_port', '') }}" placeholder="输入出发港">
                </div>
                <div class="col-md-2">
                  <label for="filter_destination_port" class="form-label">目的港</label>
                  <input type="text" class="form-control form-control-sm" id="filter_destination_port" name="destination_port" 
                         value="{{ request.args.get('destination_port', '') }}" placeholder="输入目的港">
                </div>
                <div class="col-md-2">
                  <label for="filter_valid_until" class="form-label">有效期</label>
                  <select class="form-select form-select-sm" id="filter_valid_until" name="valid_until">
                    <option value="">全部</option>
                    <option value="valid" {% if request.args.get('valid_until') == 'valid' %}selected{% endif %}>有效</option>
                    <option value="expired" {% if request.args.get('valid_until') == 'expired' %}selected{% endif %}>已过期</option>
                  </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <div class="btn-group w-100" role="group">
                    <button type="submit" class="btn btn-primary btn-sm" onclick="scrollToResults()">
                      <i class="fas fa-search me-1"></i>筛选
                    </button>
                    <a href="{{ url_for('freight_quotes') }}" class="btn btn-outline-secondary btn-sm">
                      <i class="fas fa-times me-1"></i>清除
                    </a>
                  </div>
                </div>
              </form>
            </div>
          </div>
          
          <!-- 当前筛选条件显示 -->
          {% if request.args.get('freight_forwarder') or request.args.get('shipping_company') or request.args.get('departure_port') or request.args.get('destination_port') or request.args.get('valid_until') %}
          <div class="row mb-3" id="filter-results">
            <div class="col-md-12">
              <div class="alert alert-info alert-sm">
                <i class="fas fa-filter me-2"></i>
                <strong>当前筛选条件：</strong>
                {% if request.args.get('freight_forwarder') %}
                  {% for ff in freight_forwarders %}
                    {% if ff.id|string == request.args.get('freight_forwarder') %}
                      <span class="badge bg-primary me-2">货代：{{ ff.name }}</span>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% if request.args.get('shipping_company') %}
                  <span class="badge bg-primary me-2">船公司：{{ request.args.get('shipping_company') }}</span>
                {% endif %}
                {% if request.args.get('departure_port') %}
                  <span class="badge bg-primary me-2">出发港：{{ request.args.get('departure_port') }}</span>
                {% endif %}
                {% if request.args.get('destination_port') %}
                  <span class="badge bg-primary me-2">目的港：{{ request.args.get('destination_port') }}</span>
                {% endif %}
                {% if request.args.get('valid_until') %}
                  <span class="badge bg-primary me-2">有效期：{{ '有效' if request.args.get('valid_until') == 'valid' else '已过期' }}</span>
                {% endif %}
                <span class="badge bg-success me-2">共找到 {{ quotes|length }} 条记录</span>
              </div>
            </div>
          </div>
          {% endif %}
          
          {% if quotes %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>货代</th>
                  <th>船公司</th>
                  <th>航线</th>
                  <th>
                    <a href="{{ url_for('freight_quotes', sort='price', order='asc' if request.args.get('sort') == 'price' and request.args.get('order') == 'desc' else 'desc', freight_forwarder=request.args.get('freight_forwarder', ''), shipping_company=request.args.get('shipping_company', ''), departure_port=request.args.get('departure_port', ''), destination_port=request.args.get('destination_port', ''), valid_until=request.args.get('valid_until', '')) }}" 
                       class="text-white text-decoration-none">
                      价格（USD/20GP）
                      <i class="fas fa-sort ms-1"></i>
                    </a>
                  </th>
                  <th>有效期</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                {% for quote in quotes %}
                <tr>
                  <td>
                    <strong>{{ quote.freight_forwarder.name }}</strong>
                  </td>
                  <td>{{ quote.shipping_company }}</td>
                  <td>
                    <div>{{ quote.departure_port }} → {{ quote.destination_port }}</div>
                    <small class="text-muted">{{ quote.route_type }}</small>
                  </td>
                  <td>
                    <span class="badge bg-primary" style="font-size: 1.1em;">${{ "%.2f"|format(quote.price) }}</span>
                  </td>
                  <td>
                    <div>{{ quote.quote_date.strftime('%Y-%m-%d') }}</div>
                    <small class="text-muted">至 {{ quote.valid_until.strftime('%Y-%m-%d') }}</small>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{{ url_for('edit_freight_quote', quote_id=quote.id) }}" 
                         class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-edit"></i>
                      </a>
                      <a href="{{ url_for('delete_freight_quote', quote_id=quote.id) }}" 
                         class="btn btn-outline-danger btn-sm"
                         onclick="return confirm('确定要删除这个报价吗？')">
                        <i class="fas fa-trash"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center text-muted py-4">
            <i class="fas fa-inbox fa-3x mb-3"></i>
            <p>暂无报价记录</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 设置默认日期为今天
document.getElementById('quote_date').value = new Date().toISOString().split('T')[0];

// 滚动到结果区域
function scrollToResults() {
  // 延迟执行，确保页面加载完成后再滚动
  setTimeout(function() {
    const resultsElement = document.getElementById('filter-results');
    if (resultsElement) {
      resultsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      // 如果没有筛选结果，滚动到表格
      const tableElement = document.querySelector('.table-responsive');
      if (tableElement) {
        tableElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  }, 100);
}

// 页面加载完成后，如果有筛选参数，自动滚动到结果区域
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.toString()) {
    scrollToResults();
  }
});
</script>
{% endblock %} 