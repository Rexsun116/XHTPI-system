<!-- HTML Template for PI Edit Form -->
{% extends 'base.html' %}
{% block title %}编辑 PI - {{ pi.pi_no }}{% endblock %}
{% block content %}
{% set readonly = (pi.status == '已完成') %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-4">编辑 PI - {{ pi.pi_no }}</h2>
      <div class="alert alert-info text-center" role="alert">
        {% if pi.status == '已完成' %}
        订单已完成，无法编辑。如需修改，请联系管理员。
        {% else %}
        请填写或更新以下PI信息，带 <span class="text-danger">*</span> 为必填项
        {% endif %}
      </div>
    </div>
  </div>

  <form method="post" class="needs-validation" novalidate>
    <!-- 基本信息卡片 -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">基本信息</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="pi_no" class="form-label">PI编号</label>
            <input type="text" class="form-control" id="pi_no" name="pi_no" value="{{ pi.pi_no }}" readonly {% if readonly %}disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label for="pi_date" class="form-label">PI日期</label>
            <input type="date" class="form-control" id="pi_date" name="pi_date" value="{{ pi.pi_date }}" required {% if readonly %}readonly disabled{% endif %}>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="exporter_id" class="form-label">出口商</label>
            <select class="form-select" id="exporter_id" name="exporter_id" required {% if readonly %}disabled{% endif %}>
              {% for exporter in exporters %}
              <option value="{{ exporter.id }}" {% if exporter.id == pi.exporter_id %}selected{% endif %}>{{ exporter.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label for="customer_id" class="form-label">客户（进口商）</label>
            <select class="form-select" id="customer_id" name="customer_id" required {% if readonly %}disabled{% endif %}>
              {% for customer in customers %}
              <option value="{{ customer.id }}" {% if customer.id == pi.customer_id %}selected{% endif %}>{{ customer.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="payment_terms" class="form-label">付款方式</label>
            <input type="text" class="form-control" id="payment_terms" name="payment_terms" value="{{ pi.payment_terms or '' }}" required {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label for="shipment_date" class="form-label">计划发运日期</label>
            <input type="date" class="form-control" id="shipment_date" name="shipment_date" value="{{ pi.shipment_date }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="loading_port" class="form-label">出发港口</label>
            <input type="text" class="form-control" id="loading_port" name="loading_port" value="{{ pi.loading_port or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label for="destination_port" class="form-label">目的港口</label>
            <input type="text" class="form-control" id="destination_port" name="destination_port" value="{{ pi.destination_port or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
        </div>

        <div class="mb-3">
          <label for="bank" class="form-label">收款银行信息</label>
          <textarea class="form-control" id="bank" name="bank" rows="3" {% if readonly %}readonly disabled{% endif %}>{{ pi.bank or '' }}</textarea>
        </div>

        <div class="mb-3">
          <label for="note" class="form-label">备注</label>
          <textarea class="form-control" id="note" name="note" rows="2" {% if readonly %}readonly disabled{% endif %}>{{ pi.note or '' }}</textarea>
        </div>
      </div>
    </div>

    <!-- 产品明细卡片 -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">产品明细</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="product-table" class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th class="text-center">产品</th>
                <th class="text-center">厂家</th>
                <th class="text-center">贸易方式</th>
                <th class="text-center">单价 (USD)</th>
                <th class="text-center">数量 (MT)</th>
                <th class="text-center">总价</th>
                <th class="text-center">操作</th>
              </tr>
            </thead>
            <tbody id="product-rows">
              {% for product in pi.products %}
              <tr>
                <td>
                  <select name="product_{{ loop.index0 }}" class="form-select" required {% if readonly %}disabled{% endif %}>
                    {% for p in products %}
                    <option value="{{ p.id }}" {% if product.product_id == p.id %}selected{% endif %}>{{ p.model }}{% if p.brand %} / {{ p.brand }}{% endif %}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <select name="factory_{{ loop.index0 }}" class="form-select" required {% if readonly %}disabled{% endif %}>
                    {% for f in factories %}
                    <option value="{{ f.id }}" {% if product.factory_id == f.id %}selected{% endif %}>{{ f.name }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input name="trade_term_{{ loop.index0 }}" type="text" class="form-control" value="{{ product.trade_term }}" required {% if readonly %}readonly disabled{% endif %}>
                </td>
                <td>
                  <input name="unit_price_{{ loop.index0 }}" type="number" step="0.01" class="form-control" value="{{ product.unit_price }}" oninput="updateTotal(this)" required {% if readonly %}readonly disabled{% endif %}>
                </td>
                <td>
                  <input name="quantity_{{ loop.index0 }}" type="number" step="1" class="form-control" value="{{ product.quantity|int }}" oninput="updateTotal(this)" required {% if readonly %}readonly disabled{% endif %}>
                </td>
                <td>
                  <input name="total_price_{{ loop.index0 }}" type="text" class="form-control" value="{{ product.total_price }}" readonly {% if readonly %}disabled{% endif %}>
                </td>
                <td class="text-center">
                  {% if not readonly %}
                  <button type="button" class="btn btn-outline-danger btn-sm delete-btn" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-trash"></i>
                  </button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-success" onclick="addProductRow()">
            <i class="fas fa-plus"></i> 添加产品
          </button>
        </div>
      </div>
    </div>

    {# 发运准备信息 #}
    {% if pi.status in ['待发运', '已发运', '已到港', '已完成'] %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">发运准备信息</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label>货代公司</label>
            <select class="form-select" name="freight_forwarder_id" {% if readonly %}disabled{% endif %}>
              <option value="">请选择货代</option>
              {% for ff in freight_forwarders %}
              <option value="{{ ff.id }}" {% if pi.freight_forwarder_id == ff.id %}selected{% endif %}>
                {{ ff.code }} - {{ ff.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>海运费</label>
            <input type="number" step="0.01" class="form-control" name="ocean_freight" value="{{ pi.ocean_freight or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>装柜时间</label>
            <input type="date" class="form-control" name="container_date" value="{{ pi.container_date or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>装柜地址</label>
            <input type="text" class="form-control" name="container_location" value="{{ pi.container_location or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>ETD</label>
            <input type="date" class="form-control" name="etd" value="{{ pi.etd or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>ETA</label>
            <input type="date" class="form-control" name="eta" value="{{ pi.eta or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>产地证（COO）</label>
            <select class="form-select" name="coo_required" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="需要" {% if pi.coo_required == '需要' %}selected{% endif %}>需要</option>
              <option value="不需要" {% if pi.coo_required == '不需要' %}selected{% endif %}>不需要</option>
              <option value="已完成" {% if pi.coo_required == '已完成' %}selected{% endif %}>已完成</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>产地证（APTA）</label>
            <select class="form-select" name="apta_required" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="需要" {% if pi.apta_required == '需要' %}selected{% endif %}>需要</option>
              <option value="不需要" {% if pi.apta_required == '不需要' %}selected{% endif %}>不需要</option>
              <option value="已完成" {% if pi.apta_required == '已完成' %}selected{% endif %}>已完成</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>出口许可证</label>
            <select class="form-select" name="export_license_required" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="需要" {% if pi.export_license_required == '需要' %}selected{% endif %}>需要</option>
              <option value="不需要" {% if pi.export_license_required == '不需要' %}selected{% endif %}>不需要</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>报关文件</label>
            <select class="form-select" name="customs_docs_required" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="需要" {% if pi.customs_docs_required == '需要' %}selected{% endif %}>需要</option>
              <option value="不需要" {% if pi.customs_docs_required == '不需要' %}selected{% endif %}>不需要</option>
            </select>
          </div>
          <div class="col-md-12 mb-3">
            <label>其他文件</label>
            <input type="text" class="form-control" name="other_documents" value="{{ pi.other_documents or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {# 托书信息 #}
    {% if pi.status in ['待发运', '已发运', '已到港', '已完成'] %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">托书信息</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label>航名/航次</label>
            <input type="text" class="form-control" name="vessel_info" value="{{ pi.vessel_info or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>订舱号码</label>
            <input type="text" class="form-control" name="booking_number" value="{{ pi.booking_number or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>箱型和箱量</label>
            <select class="form-select" name="container_type_quantity" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="1*20GP" {% if pi.container_type_quantity == '1*20GP' %}selected{% endif %}>1*20GP</option>
              <option value="2*20GP" {% if pi.container_type_quantity == '2*20GP' %}selected{% endif %}>2*20GP</option>
              <option value="3*20GP" {% if pi.container_type_quantity == '3*20GP' %}selected{% endif %}>3*20GP</option>
              <option value="1*40GP" {% if pi.container_type_quantity == '1*40GP' %}selected{% endif %}>1*40GP</option>
              <option value="2*40GP" {% if pi.container_type_quantity == '2*40GP' %}selected{% endif %}>2*40GP</option>
              <option value="1*40HQ" {% if pi.container_type_quantity == '1*40HQ' %}selected{% endif %}>1*40HQ</option>
              <option value="2*40HQ" {% if pi.container_type_quantity == '2*40HQ' %}selected{% endif %}>2*40HQ</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>SHIPPING MARK</label>
            <input type="text" class="form-control" name="shipping_mark" value="{{ pi.shipping_mark or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>运输条款</label>
            <input type="text" class="form-control" name="freight_term" value="{{ pi.freight_term or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>约号</label>
            <input type="text" class="form-control" name="contract_number" value="{{ pi.contract_number or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>运费条款</label>
            <input type="text" class="form-control" name="freight_clause" value="{{ pi.freight_clause or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>正本/WAYBILL</label>
            <input type="text" class="form-control" name="waybill_option" value="{{ pi.waybill_option or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>箱号</label>
            <input type="text" class="form-control" name="container_number" value="{{ pi.container_number or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>封号</label>
            <input type="text" class="form-control" name="seal_number" value="{{ pi.seal_number or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>箱型</label>
            <input type="text" class="form-control" name="container_type" value="{{ pi.container_type or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>件数</label>
            <input type="number" step="1" class="form-control" name="quantity_units" value="{{ pi.quantity_units or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>毛重</label>
            <input type="number" step="0.01" class="form-control" name="gross_weight" value="{{ pi.gross_weight or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>体积</label>
            <input type="number" step="0.01" class="form-control" name="volume" value="{{ pi.volume or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>VGM</label>
            <input type="text" class="form-control" name="vgm" value="{{ pi.vgm or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>总计件数</label>
            <input type="number" step="1" class="form-control" name="total_quantity" value="{{ pi.total_quantity or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>总计件数单位</label>
            <select class="form-select" name="total_quantity_unit" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="BAGS" {% if pi.total_quantity_unit == 'BAGS' %}selected{% endif %}>BAGS</option>
              <option value="PALLETS" {% if pi.total_quantity_unit == 'PALLETS' %}selected{% endif %}>PALLETS</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>总计毛重</label>
            <input type="number" step="0.01" class="form-control" name="total_weight" value="{{ pi.total_weight or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>总计毛重单位</label>
            <select class="form-select" name="total_weight_unit" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="KGS" {% if pi.total_weight_unit == 'KGS' %}selected{% endif %}>KGS</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>总计体积</label>
            <input type="number" step="0.01" class="form-control" name="total_volume" value="{{ pi.total_volume or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>总计体积单位</label>
            <select class="form-select" name="total_volume_unit" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="CBM" {% if pi.total_volume_unit == 'CBM' %}selected{% endif %}>CBM</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>总计VGM</label>
            <input type="text" class="form-control" name="total_vgm" value="{{ pi.total_vgm or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {# 已发运信息 #}
    {% if pi.status in ['已发运', '已到港', '已完成'] %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">已发运信息</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label>提单号</label>
            <input type="text" class="form-control" name="bill_of_lading" value="{{ pi.bill_of_lading or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>船公司</label>
            <input type="text" class="form-control" name="shipping_company" value="{{ pi.shipping_company or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>实际发运日期</label>
            <input type="date" class="form-control" name="actual_departure_date" value="{{ pi.actual_departure_date or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>批号</label>
            <input type="text" class="form-control" name="batch_no" value="{{ pi.batch_no or '' }}" placeholder="多个批号用 ; 分隔" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>COA质检单</label>
            <select class="form-select" name="coa_status" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="需要" {% if pi.coa_status == '需要' %}selected{% endif %}>需要</option>
              <option value="不需要" {% if pi.coa_status == '不需要' %}selected{% endif %}>不需要</option>
              <option value="已完成" {% if pi.coa_status == '已完成' %}selected{% endif %}>已完成</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>保险单</label>
            <select class="form-select" name="insurance_status" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="需要" {% if pi.insurance_status == '需要' %}selected{% endif %}>需要</option>
              <option value="不需要" {% if pi.insurance_status == '不需要' %}selected{% endif %}>不需要</option>
              <option value="已完成" {% if pi.insurance_status == '已完成' %}selected{% endif %}>已完成</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>原件邮寄状态</label>
            <select class="form-select" name="document_shipping_status" onchange="toggleTrackingNumber(this)" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="已邮寄" {% if pi.document_shipping_status == '已邮寄' %}selected{% endif %}>已邮寄</option>
              <option value="未邮寄" {% if pi.document_shipping_status == '未邮寄' %}selected{% endif %}>未邮寄</option>
              <option value="不需要" {% if pi.document_shipping_status == '不需要' %}selected{% endif %}>不需要</option>
            </select>
          </div>
          <div class="col-md-6 mb-3" id="tracking_number_div" style="display: {% if pi.document_shipping_status == '已邮寄' %}block{% else %}none{% endif %};">
            <label>邮件单号</label>
            <input type="text" class="form-control" name="tracking_number" value="{{ pi.tracking_number or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>货款收齐状态</label>
            <select class="form-select" name="payment_received" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="已收齐" {% if pi.payment_received == '已收齐' %}selected{% endif %}>已收齐</option>
              <option value="未收齐" {% if pi.payment_received == '未收齐' %}selected{% endif %}>未收齐</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>结汇文件需求</label>
            <select class="form-select" name="settlement_documents_required" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="需要" {% if pi.settlement_documents_required == '需要' %}selected{% endif %}>需要</option>
              <option value="不需要" {% if pi.settlement_documents_required == '不需要' %}selected{% endif %}>不需要</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {# 已到港信息 #}
    {% if pi.status in ['已到港', '已完成'] %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">已到港信息</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label>实际到港日期</label>
            <input type="date" class="form-control" name="actual_arrival_date" value="{{ pi.actual_arrival_date or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>货款收齐状态</label>
            <select class="form-select" name="payment_received" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="已收齐" {% if pi.payment_received == '已收齐' %}selected{% endif %}>已收齐</option>
              <option value="未收齐" {% if pi.payment_received == '未收齐' %}selected{% endif %}>未收齐</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>货代账单金额</label>
            <input type="number" step="0.01" class="form-control" name="freight_invoice_amount" value="{{ pi.freight_invoice_amount or '' }}" {% if readonly %}readonly disabled{% endif %}>
          </div>
          <div class="col-md-6 mb-3">
            <label>货代账单确认状态</label>
            <select class="form-select" name="freight_invoice_confirmed" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="已确认" {% if pi.freight_invoice_confirmed == '已确认' %}selected{% endif %}>已确认</option>
              <option value="未确认" {% if pi.freight_invoice_confirmed == '未确认' %}selected{% endif %}>未确认</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>货代发票开具状态</label>
            <select class="form-select" name="freight_invoice_issued" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="已开具" {% if pi.freight_invoice_issued == '已开具' %}selected{% endif %}>已开具</option>
              <option value="未开具" {% if pi.freight_invoice_issued == '未开具' %}selected{% endif %}>未开具</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>电放状态</label>
            <select class="form-select" name="telex_release" {% if readonly %}disabled{% endif %}>
              <option value="">请选择</option>
              <option value="已电放" {% if pi.telex_release == '已电放' %}selected{% endif %}>已电放</option>
              <option value="未电放" {% if pi.telex_release == '未电放' %}selected{% endif %}>未电放</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if pi.status == '已完成' %}
    <!-- 已完成信息 -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">已完成信息</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label>货代账单付款状态</label>
            <select class="form-select" name="freight_payment_status" disabled>
              <option value="">请选择</option>
              <option value="已付款" {% if pi.freight_payment_status == '已付款' %}selected{% endif %}>已付款</option>
              <option value="未付款" {% if pi.freight_payment_status == '未付款' %}selected{% endif %}>未付款</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- 隐藏保存按钮 -->
    {% if not readonly %}
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
      <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">取消</a>
      <button type="submit" class="btn btn-primary">保存修改</button>
    </div>
    {% else %}
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
      <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">返回</a>
    </div>
    {% endif %}
  </form>
</div>

<script>
  let productIndex = {{ pi.products|length if pi.products else 0 }};

  function addProductRow() {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>
        <select name="product_${productIndex}" class="form-select" required>
          {% for p in products %}
            <option value="{{ p.id }}">{{ p.model }}{% if p.brand %} / {{ p.brand }}{% endif %}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <select name="factory_${productIndex}" class="form-select" required>
          {% for f in factories %}
            <option value="{{ f.id }}">{{ f.name }}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input name="trade_term_${productIndex}" type="text" class="form-control" required>
      </td>
      <td>
        <input name="unit_price_${productIndex}" type="number" step="0.01" class="form-control" oninput="updateTotal(this)" required>
      </td>
      <td>
        <input name="quantity_${productIndex}" type="number" step="1" class="form-control" oninput="updateTotal(this)" required>
      </td>
      <td>
        <input name="total_price_${productIndex}" type="text" class="form-control" readonly>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm delete-btn" onclick="this.parentElement.parentElement.remove()">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    document.getElementById("product-rows").appendChild(row);
    productIndex++;
  }

  function updateTotal(input) {
    const row = input.closest("tr");
    const price = parseFloat(row.querySelector(`[name^='unit_price_']`).value) || 0;
    const qty = parseFloat(row.querySelector(`[name^='quantity_']`).value) || 0;
    row.querySelector(`[name^='total_price_']`).value = (price * qty).toFixed(2);
  }

  // 表单验证
  (function () {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
  })();

  // 邮件单号显示/隐藏逻辑
  function toggleTrackingNumber(select) {
    const trackingDiv = document.getElementById('tracking_number_div');
    if (select.value === '已邮寄') {
      trackingDiv.style.display = 'block';
    } else {
      trackingDiv.style.display = 'none';
      // 清空邮件单号
      trackingDiv.querySelector('input[name="tracking_number"]').value = '';
    }
  }
</script>
{% endblock %}
