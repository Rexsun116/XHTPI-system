{% extends "base.html" %}
{% block title %}工厂直发订单Dashboard - 西合钛贸易管理系统{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>工厂直发订单 Dashboard</h2>
    <div>
      <a href="{{ url_for('create_pi_commission') }}" class="btn btn-warning me-2">新建工厂直发订单</a>
    </div>
  </div>

  <!-- 统计卡片 -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="mb-0">{{ chart_data.totalStats.totalOrders }}</h4>
              <small>总订单数</small>
            </div>
            <div class="align-self-center">
              <i class="fas fa-file-invoice fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="mb-0">{{ chart_data.totalStats.completedOrders }}</h4>
              <small>已完成订单</small>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="mb-0">{{ chart_data.totalStats.inProgressOrders }}</h4>
              <small>进行中订单</small>
            </div>
            <div class="align-self-center">
              <i class="fas fa-clock fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="mb-0">${{ "{:,.0f}".format(chart_data.totalStats.totalAmount) }}</h4>
              <small>总金额(USD)</small>
            </div>
            <div class="align-self-center">
              <i class="fas fa-dollar-sign fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 图表区域 -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm chart-card">
        <div class="card-header bg-navy text-white">
          <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>订单状态分布</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm chart-card">
        <div class="card-header bg-navy text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>月度订单趋势</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm chart-card">
        <div class="card-header bg-navy text-white">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>客户订单金额排行</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="customerChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm chart-card">
        <div class="card-header bg-navy text-white">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>厂家订单金额排行</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="factoryChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm chart-card">
        <div class="card-header bg-navy text-white">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>产品销量统计</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="productChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 工厂直发订单列表区域 -->
  <div class="pi-list-section">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-navy text-white">
        <h5 class="mb-0">
          <i class="fas fa-list me-2"></i> 工厂直发订单列表
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="piTable" class="table table-hover mb-0">
            <thead class="bg-light-gray">
              <tr>
                <th onclick="sortTable(0)" class="sortable-header text-navy">PI 编号</th>
                <th onclick="sortTable(1)" class="sortable-header text-navy">日期</th>
                <th class="text-navy">客户</th>
                <th class="text-navy">厂家</th>
                <th class="text-navy">佣金收取方</th>
                <th class="text-navy">产品型号</th>
                <th class="text-navy">数量</th>
                <th class="text-navy">金额</th>
                <th class="text-navy">出发港</th>
                <th class="text-navy">目的港</th>
                <th class="text-navy">状态</th>
                <th class="text-navy">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for pi in pi_list %}
              {% if pi.commission_factory_id or pi.commission_exporter_id %}
              <tr class="table-row-hover">
                <td class="fw-bold text-navy">{{ pi.pi_no }}</td>
                <td>{{ pi.pi_date.strftime('%Y-%m-%d') }}</td>
                <td style="max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  <span title="{{ pi.customer_name_snapshot or (pi.customer.name if pi.customer else '') }}">{{ pi.customer_name_snapshot or (pi.customer.name if pi.customer else '') }}</span>
                </td>
                <td>{{ pi.commission_factory.name if pi.commission_factory else '-' }}</td>
                <td>{{ pi.commission_exporter.name if pi.commission_exporter else '-' }}</td>
                <td>
                  {% if pi.products %}
                    {% for item in pi.products %}
                      {{ item.product_model_snapshot or (item.product.model if item.product else '-') }}{% if not loop.last %}<br>{% endif %}
                    {% endfor %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if pi.products %}
                    {% for item in pi.products %}
                      {{ item.quantity | int if item.quantity else '-' }}{% if not loop.last %}<br>{% endif %}
                    {% endfor %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ (pi.products | sum(attribute='total_price')) | int | format_number if pi.products else '-' }}</td>
                <td>{{ pi.loading_port or '-' }}</td>
                <td>{{ pi.destination_port or '-' }}</td>
                <td>
                  {% if pi.status == '已完成' %}
                    <span class="badge bg-success rounded-pill">{{ pi.status }}</span>
                  {% else %}
                    <span class="badge bg-secondary rounded-pill">{{ pi.status }}</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex flex-row gap-2">
                    <a href="{{ url_for('view_pi', pi_id=pi.id) }}" class="btn btn-sm btn-outline-navy me-1">
                      <i class="fas fa-eye me-1"></i>查看
                    </a>
                    <a href="{{ url_for('edit_commission_pi', pi_id=pi.id) }}" class="btn btn-sm btn-accent">
                      <i class="fas fa-edit me-1"></i>编辑
                    </a>
                  </div>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* 复用pi_list页面样式 */
  :root {
    --navy-blue: #1e3a8a;
    --light-navy: #3b82f6;
    --accent-color: #f59e0b;
    --light-gray: #f8fafc;
    --medium-gray: #e2e8f0;
    --dark-gray: #64748b;
  }
  .text-navy { color: var(--navy-blue) !important; }
  .text-accent { color: var(--accent-color) !important; }
  .bg-navy { background-color: var(--navy-blue) !important; }
  .bg-light-gray { background-color: var(--light-gray) !important; }
  .bg-accent { background-color: var(--accent-color) !important; }
  .btn-outline-navy {
    color: var(--navy-blue);
    border-color: var(--navy-blue);
  }
  .btn-outline-navy:hover {
    color: white;
    background-color: var(--navy-blue);
    border-color: var(--navy-blue);
  }
  .btn-accent {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
  }
  .btn-accent:hover {
    background-color: #d97706;
    border-color: #d97706;
    color: white;
  }
  .sortable-header {
    cursor: pointer;
    position: relative;
  }
  .sortable-header::after {
    content: "▼";
    font-size: 0.7em;
    color: #6c757d;
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
  }
  .table-row-hover:hover {
    background-color: var(--light-gray);
  }
  .card {
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  .card-header {
    border-radius: 15px 15px 0 0;
    border: none;
  }
  .chart-container {
    position: relative;
    height: 200px;
  }
  .chart-card {
    transition: transform 0.2s ease-in-out;
  }
  .chart-card:hover {
    transform: translateY(-2px);
  }
  .card {
    transition: all 0.3s ease;
  }
  .card:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }
  @media (max-width: 768px) {
    .display-6 {
      font-size: 1.5rem;
    }
  }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // 图表数据
  const chartData = {{ chart_data | tojson }};

  // 1. 订单状态分布（环形图）
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: chartData.statusData.labels,
      datasets: [{
        data: chartData.statusData.data,
        backgroundColor: [
          'rgba(34, 197, 94, 0.8)',   // 绿色 - 已完成
          'rgba(59, 130, 246, 0.8)',  // 蓝色 - 进行中
          'rgba(245, 158, 11, 0.8)',  // 橙色 - 待发运
          'rgba(239, 68, 68, 0.8)',   // 红色 - 已发运
          'rgba(139, 92, 246, 0.8)'   // 紫色 - 已到港
        ],
        borderColor: [
          '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // 2. 月度订单趋势（折线图）
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: chartData.trendData.labels,
      datasets: [{
        label: '订单数量',
        data: chartData.trendData.data,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });

  // 3. 客户订单金额排行
  const customerCtx = document.getElementById('customerChart').getContext('2d');
  new Chart(customerCtx, {
    type: 'bar',
    data: {
      labels: chartData.customerData.labels,
      datasets: [{
        label: '订单金额 (USD)',
        data: chartData.customerData.data,
        backgroundColor: [
          'rgba(59, 130, 246, 0.8)',   // 蓝色
          'rgba(16, 185, 129, 0.8)',   // 绿色
          'rgba(245, 158, 11, 0.8)',   // 橙色
          'rgba(239, 68, 68, 0.8)',    // 红色
          'rgba(139, 92, 246, 0.8)',   // 紫色
          'rgba(236, 72, 153, 0.8)',   // 粉色
          'rgba(34, 197, 94, 0.8)',    // 翠绿
          'rgba(251, 146, 60, 0.8)'    // 橙红
        ],
        borderColor: [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
          '#ec4899', '#22c55e', '#fb923c'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // 4. 厂家订单金额排行
  const factoryCtx = document.getElementById('factoryChart').getContext('2d');
  new Chart(factoryCtx, {
    type: 'bar',
    data: {
      labels: chartData.factoryData.labels,
      datasets: [{
        label: '订单金额 (USD)',
        data: chartData.factoryData.data,
        backgroundColor: [
          'rgba(34, 197, 94, 0.8)',    // 翠绿
          'rgba(59, 130, 246, 0.8)',   // 蓝色
          'rgba(245, 158, 11, 0.8)',   // 橙色
          'rgba(239, 68, 68, 0.8)',    // 红色
          'rgba(139, 92, 246, 0.8)',   // 紫色
          'rgba(236, 72, 153, 0.8)',   // 粉色
          'rgba(16, 185, 129, 0.8)',   // 绿色
          'rgba(251, 146, 60, 0.8)'    // 橙红
        ],
        borderColor: [
          '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
          '#ec4899', '#10b981', '#fb923c'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // 5. 产品销量统计
  const productCtx = document.getElementById('productChart').getContext('2d');
  new Chart(productCtx, {
    type: 'bar',
    data: {
      labels: chartData.productData.labels,
      datasets: [{
        label: '销量 (MT)',
        data: chartData.productData.data,
        backgroundColor: [
          'rgba(16, 185, 129, 0.8)',   // 绿色
          'rgba(59, 130, 246, 0.8)',   // 蓝色
          'rgba(245, 158, 11, 0.8)',   // 橙色
          'rgba(239, 68, 68, 0.8)',    // 红色
          'rgba(139, 92, 246, 0.8)',   // 紫色
          'rgba(236, 72, 153, 0.8)',   // 粉色
          'rgba(34, 197, 94, 0.8)',    // 翠绿
          'rgba(251, 146, 60, 0.8)'    // 橙红
        ],
        borderColor: [
          '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
          '#ec4899', '#22c55e', '#fb923c'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString() + ' MT';
            }
          }
        }
      }
    }
  });



  // 简单表格排序（按点击的列排序）
  function sortTable(n) {
    const table = document.getElementById("piTable");
    let switching = true, dir = "asc", switchcount = 0;
    while (switching) {
      switching = false;
      const rows = table.rows;
      for (let i = 1; i < rows.length - 1; i++) {
        let shouldSwitch = false;
        let x = rows[i].getElementsByTagName("TD")[n];
        let y = rows[i + 1].getElementsByTagName("TD")[n];
        let xContent = x.innerText || x.textContent;
        let yContent = y.innerText || y.textContent;
        if (!isNaN(Date.parse(xContent)) && !isNaN(Date.parse(yContent))) {
          xContent = new Date(xContent);
          yContent = new Date(yContent);
        }
        if (dir == "asc" && xContent > yContent) shouldSwitch = true;
        if (dir == "desc" && xContent < yContent) shouldSwitch = true;
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++;
        }
      }
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
</script>
{% endblock %} 