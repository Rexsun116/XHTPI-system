{% extends "base.html" %}
{% block title %}创建 PI - 西合钛贸易管理系统{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-4">创建 PI</h2>
      <div class="alert alert-info text-center" role="alert">
        请填写以下PI信息，带 <span class="text-danger">*</span> 为必填项
      </div>
    </div>
  </div>

  <form method="POST" class="needs-validation" novalidate>
    <!-- 基本信息卡片 -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">基本信息</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="pi_no" class="form-label">PI编号 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="pi_no" name="pi_no" required>
            <div id="pi_no_feedback" class="form-text"></div>
            <div id="pi_no_validation" class="invalid-feedback"></div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="pi_date" class="form-label">PI日期 <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="pi_date" name="pi_date" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="exporter" class="form-label">出口商 <span class="text-danger">*</span></label>
            <select class="form-select" id="exporter" name="exporter" required>
              <option value="">请选择出口商</option>
              {% for e in exporters %}
              <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label for="customer" class="form-label">客户（进口商） <span class="text-danger">*</span></label>
            <select class="form-select" id="customer" name="customer" required>
              <option value="">请选择客户</option>
              {% for c in customers %}
              <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="payment_terms" class="form-label">付款方式</label>
            <input type="text" class="form-control" id="payment_terms" name="payment_terms">
          </div>
          <div class="col-md-6 mb-3">
            <label for="shipment_date" class="form-label">计划发运日期</label>
            <input type="date" class="form-control" id="shipment_date" name="shipment_date">
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="loading_port" class="form-label">出发港口</label>
            <input type="text" class="form-control" id="loading_port" name="loading_port">
          </div>
          <div class="col-md-6 mb-3">
            <label for="destination_port" class="form-label">目的港口</label>
            <input type="text" class="form-control" id="destination_port" name="destination_port">
          </div>
        </div>

        <div class="mb-3">
          <label for="bank_selector" class="form-label">收款银行</label>
          <select class="form-select mb-2" id="bank_selector">
            <option value="">请选择银行账户</option>
            <option value="Account with Bank: Hang Seng Bank Limited&#10;Bank address: 83 Des Voeux Road Central Hong Kong&#10;Beneficiary: AEA MARKETING LIMITED&#10;Account number: 255-563587-883&#10;SWIFT Code: HASEHKHH">
              银行账户 1 - Hang Seng Bank HK
            </option>
            <option value="ACCOUNT WITH BANK: BANK OF CHINA,CHENGDU QINGYANG SUB-BRANCH&#10;ADD: TOWER B JINGSHA WINERA PLAZA,&#10;NO 1 SHUJIN ROAD, CHENGDU, SICHUAN, CHINA&#10;SWIFT CODE: BKCHCNBJ570&#10;BENEFICIARY: CHENGDU XHTI TECHNOLOGY CO.,LTD&#10;ADDRESS: Room 1823,No 7 HangKong Road,Chengdu City&#10;ACCOUNT NO: 117206727382">
              银行账户 2 - BOC CHINA
            </option>
            <option value="Account with Bank: OCBC BANK (HONGKONG) LIMITED&#10;Bank address: 161 QUEEN'S ROAD CENTRAL, HONGKONG&#10;Beneficiary: AEA MARKETING LIMITED&#10;Account number: 802-215349-831&#10;SWIFT Code: WIHBHKHH&#10;Bank Code: 035">
              银行账户 3 - OCBC Bank HK
            </option>
          </select>
          <textarea class="form-control" id="bank_text" name="bank" rows="6" placeholder="请选择银行账户或手动填写银行信息"></textarea>
        </div>

        <div class="mb-3">
          <label for="note" class="form-label">备注</label>
          <input type="text" class="form-control" id="note" name="note" placeholder="默认：Please arrange shipment as scheduled.">
        </div>
      </div>
    </div>

    <!-- 产品明细卡片 -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">产品明细</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="product-table" class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th class="text-center">产品</th>
                <th class="text-center">厂家</th>
                <th class="text-center">贸易方式</th>
                <th class="text-center">单价 (USD)</th>
                <th class="text-center">数量 (MT)</th>
                <th class="text-center">总价</th>
                <th class="text-center">操作</th>
              </tr>
            </thead>
            <tbody id="product-rows">
            </tbody>
          </table>
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-success" onclick="addProductRow()">
            <i class="fas fa-plus"></i> 添加产品
          </button>
        </div>
      </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
      <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">取消</a>
      <button type="submit" class="btn btn-primary">创建 PI</button>
    </div>
  </form>
</div>

<script>
  let productIndex = 0;

  // 银行选择器功能
  document.getElementById('bank_selector').addEventListener('change', function () {
    const selectedValue = this.value;
    if (selectedValue) {
      document.getElementById('bank_text').value = selectedValue.replace(/&#10;/g, '\n');
    }
  });

  function addProductRow() {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>
        <select name="product_${productIndex}" class="form-select" required>
          <option value="">请选择产品</option>
          {% for p in products %}
            <option value="{{ p.id }}">{{ p.model }}{% if p.brand %} / {{ p.brand }}{% endif %}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <select name="factory_${productIndex}" class="form-select" required>
          <option value="">请选择厂家</option>
          {% for f in factories %}
            <option value="{{ f.id }}">{{ f.name }}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input name="trade_term_${productIndex}" type="text" class="form-control" required>
      </td>
      <td>
        <input name="unit_price_${productIndex}" type="number" step="0.01" class="form-control" oninput="updateTotal(this)" required>
      </td>
      <td>
        <input name="quantity_${productIndex}" type="number" step="1" class="form-control" oninput="updateTotal(this)" required>
      </td>
      <td>
        <input name="total_price_${productIndex}" type="text" class="form-control" readonly>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm delete-btn" onclick="this.parentElement.parentElement.remove()">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    document.getElementById("product-rows").appendChild(row);
    productIndex++;
  }

  function updateTotal(input) {
    const row = input.closest("tr");
    const price = parseFloat(row.querySelector(`[name^='unit_price_']`).value) || 0;
    const qty = parseFloat(row.querySelector(`[name^='quantity_']`).value) || 0;
    row.querySelector(`[name^='total_price_']`).value = (price * qty).toFixed(2);
  }

  // PI编号即时验证
  let piNoValidationTimer;
  const piNoInput = document.getElementById('pi_no');
  const piNoFeedback = document.getElementById('pi_no_feedback');
  const piNoValidation = document.getElementById('pi_no_validation');
  
  piNoInput.addEventListener('input', function() {
    const piNo = this.value.trim();
    
    // 清除之前的定时器
    clearTimeout(piNoValidationTimer);
    
    // 重置状态
    this.classList.remove('is-valid', 'is-invalid');
    piNoFeedback.textContent = '';
    piNoValidation.textContent = '';
    
    if (piNo === '') {
      piNoFeedback.textContent = '请输入PI编号';
      return;
    }
    
    // 显示加载状态
    piNoFeedback.textContent = '正在验证...';
    piNoFeedback.className = 'form-text text-muted';
    
    // 延迟500ms后验证，避免频繁请求
    piNoValidationTimer = setTimeout(() => {
      validatePiNo(piNo);
    }, 500);
  });
  
  function validatePiNo(piNo) {
    const formData = new FormData();
    formData.append('pi_no', piNo);
    
    fetch('/check-pi-no', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      const input = document.getElementById('pi_no');
      
      if (data.valid) {
        // 验证成功
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        piNoFeedback.textContent = data.message;
        piNoFeedback.className = 'form-text text-success';
        piNoValidation.textContent = '';
      } else {
        // 验证失败
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        piNoFeedback.textContent = '';
        piNoValidation.textContent = data.message;
      }
    })
    .catch(error => {
      console.error('验证PI编号时出错:', error);
      piNoFeedback.textContent = '验证时出现错误，请重试';
      piNoFeedback.className = 'form-text text-danger';
    });
  }
  
  // 表单验证
  (function () {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
          // 检查PI编号是否有效
          const piNoInput = document.getElementById('pi_no');
          if (piNoInput.classList.contains('is-invalid')) {
            event.preventDefault();
            event.stopPropagation();
            alert('请先解决PI编号的问题');
            return;
          }
          
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
  })();
</script>
{% endblock %}